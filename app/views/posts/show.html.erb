<p id="notice"><%= notice %></p>
<%= link_to 'New Post', post_new_path(@stud.id) %>

<table id = "Posts"></table>


<%= link_to 'Back',student_path(@stud) %>


<script>
alert = function(){};
window.onload = show_all_details();


function show_all_details()
{
	arr = ["", "Unposted", "Unverified", "Verified", "Flagged", "Rejected"];
	var table = document.getElementById("Posts");
	$.ajax({
		url:'/give_categories',
		type: 'POST',
		async: false,
		success: function(data_returned_by_server){
			categories = data_returned_by_server
		}	
	});
	var i = 0;
	for (i = 0; i < 8; i++)
	{
		var row = table.insertRow(-1);
		var cell1 = row.insertCell(0);
		str = categories[i].name.bold();
		cell1.innerHTML = str.fontsize(3.5);
		$.ajax({
            	url: '/give_subcat_posts/',
            	type: 'POST',
				data: {id: (i+1)},
				async: false,
				success: function (data_returned_by_server) {
					data_returned = data_returned_by_server
					}
					});
			
	
		var row = table.insertRow(-1);
		
		if (data_returned.types1.length == 0 && data_returned.subs1.length == 0)
		{
			$.ajax({
            	url: '/give_previous_posts/',
            	type: 'POST',
				data: {id: "<%=@stud.id%>", l1: (i+1).toString(10), l2: -1},
				async: false,
				success: function (data_returned_by_server) {
					data_returned1 = data_returned_by_server;				
				}
			
			});
			
			
			
			if (data_returned1.length == 0)
			{
			 	var cell1 = row.insertCell(0);
				cell1.innerHTML = "Not Posted";
			}
			else
			{
				for (i = 0; i < data_returned1.length; i++)
				{
					var row = table.insertRow(-1);
				
  					var cell2 = row.insertCell(0);
  					var cell3 = row.insertCell(1);
  			
  					
  			
  					cell2.innerHTML = reveal(data_returned1[i].id);
  					cell3.innerHTML = arr[data_returned1[i].status];
  			
				}
			}
			
			if (i == 0)
			{	
				length = data_returned1.length;
				if (length == 0)
				{
					break;
				}	
				else if (data_returned1[length - 1].status != 3)
					break;
			}
		}
					
		else if (data_returned.types1.length == 0)
		{
			$.ajax({
            	url: '/give_previous_posts_bysub/',
            	type: 'POST',
				data: {id: "<%=@stud.id%>", l1: (i+1).toString(10), l2: -1, l3: data_returned.subs_id1},
				async: false,
				success: function (data_returned_by_server) {
					data_returned1 = data_returned_by_server;	
				}
			});			
				
			var j = 0;
			for (j = 0; j < data_returned.subs1.length; j++)
			{
				var flag = 0;
				for (var k = 0; k < data_returned1.length; k++)
				{
					
					if (data_returned1[k].subcategory == data_returned.subs_id1[j])
					{
						flag = 1;
						var row = table.insertRow(-1);
						var cell1 = row.insertCell(0);
  						var cell2 = row.insertCell(1);
  						var cell3 = row.insertCell(2);
						cell1.innerHTML = data_returned.subs1[j];
  						cell2.innerHTML = reveal(data_returned1[k].id);
  						cell3.innerHTML = arr[data_returned1[k].status];
					}
					
				}
  			
  				if (flag == 0)
  				{			
  					var row = table.insertRow(-1);
					var cell1 = row.insertCell(0);
  					var cell2 = row.insertCell(1);
  					cell1.innerHTML = data_returned.subs1[j];
  					cell2.innerHTML = "Not Posted";
  				}
  			}
  			}
  	 			
  		else
  		{
  				var j = 0, k = 0, l = 0;	
  				for (j = 0; j < data_returned.types1.length; j++)
  				{
  					$.ajax({
            				url: '/give_previous_posts_bysub/',
            				type: 'POST',
							data: {id: "<%=@stud.id%>", l1: (i+1).toString(10), l2: data_returned.types_id1[j], l3: data_returned.subs_id1},
							async: false,
							success: function (data_returned_by_server) {
							data_returned1 = data_returned_by_server;	
							}
						});

						
					if (data_returned1.length == 0)
					{
						var row = table.insertRow(-1);
						var cell1 = row.insertCell(0);
						var row = table.insertRow(-1);
						var cell1 = row.insertCell(0);
						var row = table.insertRow(-1);
						var cell1 = row.insertCell(0);						
						cell1.innerHTML = data_returned.types1[j].bold();
						var row = table.insertRow(-1);
						var cell2 = row.insertCell(0);
						cell2.innerHTML = "Not Posted";
						if ((i + 1) == 3)
							continue;
						else
						{
							break;
						}
					}
					else
					{
						var row = table.insertRow(-1);
						var cell1 = row.insertCell(0);
						var row = table.insertRow(-1);
						var row = table.insertRow(-1);
						var cell1 = row.insertCell(0);
						cell1.innerHTML = data_returned.types1[j].bold();
					}
  					for (k = 0; k < data_returned.subs1.length; k++)
  					{
  						var flag = 0;
  						for (l = 0; l < data_returned1.length; l++)
  						{
  						
  							if (data_returned1[l].subcategory == data_returned.subs_id1[k])
							{
								
								flag = 1;
								var row = table.insertRow(-1);
								var cell1 = row.insertCell(0);
  								var cell2 = row.insertCell(1);
  								var cell3 = row.insertCell(2);
								cell1.innerHTML = data_returned.subs1[k];
  								cell2.innerHTML = reveal(data_returned1[l].id);
  								cell3.innerHTML = arr[data_returned1[l].status];
  								if (data_returned1[l].status > 2)
  								{
  									var cell4 = row.insertCell(3);
  									 
  									cell4.innerHTML = signer(data_returned1[l]); 
  									
  								}
							}
  						
  						}
  						
  						if (flag == 0)
						{
							var row = table.insertRow(-1);
							var cell1 = row.insertCell(0);
							var cell2 = row.insertCell(1);
							cell1.innerHTML = data_returned.subs1[k];
							cell2.innerHTML = "Not Posted";
									
						}
  						
  						
  					
  					}
  					
  					
  					
  					
  					
  				}
			
  				
  				
  				
  				
  			}
  			
  			
  			
  			
  			
  			
  			
  			
  			
  			
		for (var j = 0; j < 5; j ++)
		{
			var row = table.insertRow(-1);
			var cell1 = row.insertCell(0);
		}
	}
}	
		


function signer(post_details)
{

	var x = post_details.signature;
	var public_key = bigInt(post_details.sign_id, 10);
	
	var x1 = bigInt(x).modPow(bigInt("3"),bigInt(public_key));	
	var x2 = x1.toString(16);
	var y2 = x2.substring(64);
		x2 = x2.substring(0,64);
	var r1 = bigInt(y2,16).xor(bigInt(SHA256(x2),16)).toString(16);
	var message = bigInt(x2,16).xor(bigInt(SHA256(r1),16)); 	
	
	if (message.toString(16) == post_details.postkey)
			return "Signed by Verified Entity";
	else
		return "Unauthorised Verifier";

}




function reveal(a)
{
	var data_returned;
	var data_to_sent = {post_id: a, type: 1};
		$.ajax({
            	url: '/give_numbers',
            	type: 'POST',
            	datatype: 'text',
				data: data_to_sent,
				async: false,
				success: function (data_returned_by_server) {
				
				data_returned = data_returned_by_server;
            	
        		},
        		error: function (result) {
            		console.log('error');
        		}
			
            });
            
            var i;
            var sum = 0;
            for (i = 1; i < 6; i++)
            {
            	sum += data_returned[i];
            }
            
            return (cryptico.decryptAESCBC(data_returned[0], SHA256(sum.toString(16))));            
				
	
}
</script>