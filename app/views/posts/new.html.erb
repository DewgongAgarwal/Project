<h1>New Post</h1>

Category:
<select id = "category" onchange = "populate('category', 'type', 'subcategory')">
	<option value = "" selected disabled hidden>Choose One</option>
	<% @category.each do |cat| %>
		<option value = "<%=cat.id%>"  ><%= cat.name %></option>
	<%end%>
</select>
<br>
<div id = "types" hidden>
Type :
<select id = "type" onchange = "show_previous('category', 'type', 'subcategory')">

</select>
</div>

<div id = "subcategorys" hidden>
Subcategory :
<select id = "subcategory" onchange = "show_previous_bysub('category', 'type', 'subcategory')">		
</select>
</div>
<br>
<div id = "Related_Posts" hidden>
Related Posts:
<table id="Related">
</table>
</div>
<br>
<textarea rows="4" cols="50" id = "data">
Data</textarea>
<p onclick = "pass_data()">Sign and Post</p>

<%= link_to 'Back', post_path(session[:user_id]) %>


<script>
	
	var data_returned, data_returned1, data_returned2;

	function populate(l1, l2, l3)
	{
		document.getElementById("Related_Posts").style.display = "none";
		l1 = document.getElementById(l1);
		l2 = document.getElementById(l2);
		l3 = document.getElementById(l3);
		
		
		l2.options.length = 0
		var option = document.createElement("option");
		option.value = "-1";
		option.innerHTML = "Choose One";
		option.disabled = true;
		option.selected = true;
		option.hidden = true;
		l2.options.add(option);
		
		l3.options.length = 0
		var option = document.createElement("option");
		option.value = "-1";
		option.disabled = true;
		option.selected = true;
		option.hidden = true;
		option.innerHTML = "Choose One";
		l3.options.add(option);
		
		
		
		$.ajax({
            	url: '/give_subcat_posts/',
            	type: 'POST',
				data: {id: l1.value},
				async: false,
				success: function (data_returned_by_server) {
					data_returned = data_returned_by_server
					if (data_returned.subs1.length != 0)
					{
						document.getElementById("subcategorys").style.display = "block";
						for (var i = 0; i < data_returned.subs1.length; i++)
						{
							var option = document.createElement("option");
							option.value = data_returned.subs_id1[i].toString(10);
							option.innerHTML = data_returned.subs1[i];	
							l3.options.add(option);
						}
					}
					else
					{
						document.getElementById("subcategorys").style.display = "none";
					}
					if (data_returned.types1.length != 0)
					{
						document.getElementById("types").style.display = "block";
						for (var i = 0; i < data_returned.types1.length; i++)
						{
							
							var option = document.createElement("option");
							option.value = data_returned.types_id1[i].toString(10);
							option.innerHTML = data_returned.types1[i];	
							l2.options.add(option);
							$.ajax({
            					url: '/give_previous_posts/',
            					type: 'POST',
								data: {id: "<%=@stud.id%>", l1: l1.value, l2: data_returned.types_id1[i]},
								async: false,
								success: function (data_returned_by_server) {
									data_returned1 = data_returned_by_server;				
							}});
							
							if (data_returned1.length == 0)
							{
								if (l1.value == 3)
								{
									if (i >= 2)
									break;
								}
								else
								break;
							}
						}
					}	
					else
					{
						document.getElementById("types").style.display = "none";
					}
            	}
            
        
			});
		

		
		
	
	}
	
	function show_previous(l1, l2, l3)
	{
		l1 = document.getElementById(l1);
		l2 = document.getElementById(l2);
		l3 = document.getElementById(l3);
		l3.value = "-1";
		
		$.ajax({
            	url: '/give_previous_posts/',
            	type: 'POST',
				data: {id: "<%=@stud.id%>", l1: l1.value, l2: parseInt(l2.value,10)},
				async: false,
				success: function (data_returned_by_server) {
					data_returned1 = data_returned_by_server;				
				}
			
		});
		if (data_returned1.length != 0)
		{
			document.getElementById("Related_Posts").style.display = "block";
			
		}
		else
		{
			document.getElementById("Related_Posts").style.display = "none";
		}
		var table = document.getElementById("Related");
		table.innerHTML = ""
		for (i = 0; i < data_returned1.length; i++)
		{
			var row = table.insertRow(-1);
			var cell1 = row.insertCell(0);
  			var cell2 = row.insertCell(1);
  			var cell3 = row.insertCell(2);
  			var search_num = data_returned1[i].subcategory
  			var index = 0
  			for (j = 0; j < data_returned.subs_id1.length; j++)
  			{
  				if (data_returned.subs_id1[j] == search_num)
  				{
  					index = j;
  					break;
  				}
  			}
  			
  			arr = ["", "Unposted", "Unverified", "Verified", "Flagged", "Rejected"];
  			
  			cell1.innerHTML = data_returned.subs1[index];
  			cell2.innerHTML = reveal(data_returned1[i].id);
  			cell3.innerHTML = arr[data_returned1[i].status];
  			
		}
		
	}
	
	function show_previous_bysub(l1, l2, l3)
	{
		l1 = document.getElementById(l1);
		l2 = document.getElementById(l2);
		l3 = document.getElementById(l3);
		
		$.ajax({
            	url: '/give_previous_posts_bysub',
            	type: 'POST',
				data: {id: "<%=@stud.id%>", l1: l1.value, l2: parseInt(l2.value,10), l3: parseInt(l3.value,10)},
				async: false,
				success: function (data_returned_by_server) {
					data_returned2 = data_returned_by_server;				
				}
			
		});
		if (data_returned2.length != 0)
		{
			document.getElementById("Related_Posts").style.display = "block";
			
		}
		else
		{
			document.getElementById("Related_Posts").style.display = "none";
		}
		var table = document.getElementById("Related");
		table.innerHTML = ""
		for (i = 0; i < data_returned2.length; i++)
		{
			var row = table.insertRow(-1);
			var cell1 = row.insertCell(0);
  			var cell2 = row.insertCell(1);
  			var cell3 = row.insertCell(2);
  			var search_num = data_returned2[i].subcategory
  			var index = 0
  			for (j = 0; j < data_returned.subs_id1.length; j++)
  			{
  				if (data_returned.subs_id1[j] == search_num)
  				{
  					index = j;
  					break;
  				}
  			}
  			
  			arr = ["", "Unposted", "Unverified", "Verified", "Flagged", "Rejected"];
  			
  			cell1.innerHTML = data_returned.subs1[index];
  			cell2.innerHTML = reveal(data_returned2[i].id);
  			cell3.innerHTML = arr[data_returned2[i].status];
  			
		}
		
	}



	
	alert = function() {};

	function pass_data()
	{
		var category = document.getElementById("category").value;
		var type = document.getElementById("type").value;
		var subcategory = document.getElementById("subcategory").value;
		var data_passed = document.getElementById("data").value;
		
		var random_number = generate_random_number();
		
		var post_key = SHA256("<%= @stud.id %>" + " " + data_passed + " " + category +  " " + subcategory + random_number);
		
		while (post_key[0] == '0')
		{
			var random_number = generate_random_number();
			var post_key = SHA256("<%= @stud.id %>" + " " + data_passed + " " + category +  " " + subcategory + random_number);
		}
		 
		var message = bigInt(post_key,16);	
		var r = SHA256(bigInt.randBetween("-1e100", "1e100").toString(16));
		var g = bigInt(SHA256(r),16); 
		var x = g.xor(message).toString(16);
		var h = bigInt(SHA256(x),16);
		var y = bigInt(r,16).xor(h);
		message = new bigInt(x +""+ y.toString(16), 16).toString(16);
		var encrypted = bigInt(message,16).modPow(bigInt(sessionStorage.getItem("<%=@stud.email%>"+"d")),bigInt(sessionStorage.getItem("<%=@stud.email%>"+"n"))).toString();	
		
		data1 = generate_random_number();
		data2 = generate_random_number();
		data3 = generate_random_number();
		data4 = generate_random_number();
		data5 = generate_random_number();
		
		key = data1 + data2 + data3 + data4 + data5;
		key = key.toString(16);
		key = SHA256(key);
		
		data = cryptico.encryptAESCBC(data_passed, key);
		
		
		var data_to_sent = {stud_id: "<%=@stud.id%>", category: category, subcategory: subcategory, types1: type, data: data, status: 2, postkey: post_key, studentSign: encrypted, data1: data1, data2: data2, data3: data3, data4: data4, data5: data5 }; 
		$.ajax({
            	url: '/posts',
            	type: 'POST',
				data: data_to_sent,
				});
		confirm("Success");
	}
	
	function generate_random_number()
	{
		p = Math.floor(Math.random() * (100001));
		return p - 5000;
	}
	
	
	function reveal(a)
{
	var data_returned;
	var data_to_sent = {post_id: a, type: 1};
		$.ajax({
            	url: '/give_numbers',
            	type: 'POST',
            	datatype: 'text',
				data: data_to_sent,
				async: false,
				success: function (data_returned_by_server) {
				
				data_returned = data_returned_by_server;
            	
        		},
        		error: function (result) {
            		console.log('error');
        		}
			
            });
            
            var i;
            var sum = 0;
            for (i = 1; i < 6; i++)
            {
            	sum += data_returned[i];
            }
            
            return cryptico.decryptAESCBC(data_returned[0], SHA256(sum.toString(16)));            
				
	
}
	
</script>

